---
title: "Protein Quantification Report"
output:
  html_document:
    css: "style.css"
params:
  qp : NA
  target_conc : NA
  target_vol : NA
  other : list()
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(qp)
library(ggplot2)
library(dplyr)
library(gt)
library(knitr)
```


# Plots
```{r}
plate_plot <- qp_plot_plate(params$qp$qp) +
  theme_void() +
  coord_cartesian(clip = "off") +
  theme(
    plot.margin = margin(1, 0.5, 1, 0.5, unit = "cm"),
    panel.background = element_rect(fill = "transparent", color = NA),
    plot.background = element_rect(fill = "#FFFFFF33", color = NA)
  )

ggsave(
  "plate_plot.png",
  plate_plot,
  device = "png",
  width = 17, height = max(params$qp$qp$.col), units = "cm",
  bg = "transparent"
)
```

```{r}
standards_plot <- qp_plot_standards(params$qp) +
  theme_minimal() +
  theme(
    panel.background = element_rect(fill = "transparent", color = NA),
    plot.background = element_rect(fill = "#FFFFFF33", color = NA)
  )

ggsave(
  "standards_plot.png",
  standards_plot,
  device = "png",
  width = 12, height = 9, units = "cm",
  bg = "transparent"
)
```

![test](plate_plot.png){height=300px} ![test](standards_plot.png){height=300px}

# Tables


```{r message=FALSE}
dil <- qp_dilute(
  qp_summarize(params$qp),
  params$target_conc, params$target_vol, remove_standards = TRUE
)

dil |>
  select(
    Name = ".sample_name", .mean_pred_conc, .target_conc,
    "Final Vol" = ".target_vol", "Sample to Add (uL)" = sample_to_add,
    "Diluent to Add (uL)" = add_to
  ) |>
  mutate(.target_conc = round(.target_conc, 2),
         .mean_pred_conc = round(.mean_pred_conc, 2)) |>
  rename("[Target]" = .target_conc,
         "[Sample]" = .mean_pred_conc) |>
  gt() |>
  tab_options(
    table.background.color = "#FFFFFF33",
    table.border.top.color = "white",
    table.border.bottom.color = "white"
  )

```


## Summaries
:::: {style="display: flex; justify-content: space-between;"}

::: {}

```{r}
td <- qp_samples_summary(params$qp)$qp
tab_options(
  td,
  table.background.color = "#FFFFFF33",
  table.border.top.color = "white",
  table.border.bottom.color = "white"
) |>
  tab_header("Samples Summary")
```

:::


::: {}

```{r}
td <- qp_standards_summary(params$qp)$qp
tab_options(
  td,
  table.background.color = "#FFFFFF33",
  table.border.top.color = "white",
  table.border.bottom.color = "white"
) |>
  tab_header("Standards Summary")
```

:::


::::

## All
:::: {style="display: flex; justify-content: space-between;"}

:::{}

```{r}
td <- qp_samples_all(params$qp)$qp
tab_options(
  td,
  table.background.color = "#FFFFFF33",
  table.border.top.color = "white",
  table.border.bottom.color = "white"
) |>
  tab_header("Samples")
```

:::

:::{}

```{r}
td <- qp_standards_all(params$qp)$qp
tab_options(
  td,
  table.background.color = "#FFFFFF33",
  table.border.top.color = "white",
  table.border.bottom.color = "white"
) |>
  tab_header("Standards")
```

:::


::::


```{r}
# load_all()
library(rmarkdown)
f <- system.file("rmarkdown/templates/quantify-protein-report/skeleton/skeleton.Rmd", package = "qp")
out_file <- "~/Desktop/test.html"
# render(f, output_file = out_file, params = list(qp = qp(absorbances), target_vol = 30, target_conc = NULL, other = list(foo = "bar", fruit = "banana")))
```

# Report Parameters

```{r}
params$other |>
  as.data.frame() |>
  t() |>
  as_tibble(rownames = "Parameter") |>
  rename("Value" = "V1") |>
  kable()
```
